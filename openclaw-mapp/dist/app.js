"use strict";require("./vendors"),require("./taro"),require("./runtime"),(wx["webpackJsonp"]=wx["webpackJsonp"]||[]).push([[524],{980:function(e,t,n){n(8058);var s=n(6546),i=n(5173),r=n(4340),o=n.n(r),a=n(9551),c=n(2363),u=n(7653),l=n(3279),f=n(758),g=n.t(f,2),d=n(6056),h=n(5738),p=n(6693);function b(e,t,n,s){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(s):void 0})}var w=n(8677);function m(e,t,n,s,i){var r={};return Object.keys(s).forEach(function(e){r[e]=s[e]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=n.slice().reverse().reduce(function(n,s){return s(e,t,n)||n},r),i&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(i):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(e,t,r),null):r}var v,y,S,k,A,I,z,M,W,x,P,U,O,C,E,T,N,X,H=n(3132),D=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";(0,a.A)(this,e),(0,w.A)(this,"ws",null),(0,w.A)(this,"url",""),(0,w.A)(this,"reconnectTimer",null),(0,w.A)(this,"reconnectAttempts",0),(0,w.A)(this,"maxReconnectAttempts",5),(0,w.A)(this,"reconnectDelay",3e3),(0,w.A)(this,"messageHandlers",[]),(0,w.A)(this,"statusHandlers",[]),this.url=t}return(0,c.A)(e,[{key:"setUrl",value:function(e){this.url=e}},{key:"onMessage",value:function(e){this.messageHandlers.push(e)}},{key:"onStatusChange",value:function(e){this.statusHandlers.push(e)}},{key:"notifyStatus",value:function(e){this.statusHandlers.forEach(function(t){return t(e)})}},{key:"notifyMessage",value:function(e){this.messageHandlers.forEach(function(t){return t(e)})}},{key:"connect",value:function(){var e=this;return new Promise(function(t,n){if(!e.url){var s="WebSocket URL is not configured";return e.notifyStatus("error"),void n(new Error(s))}if(!e.ws||e.ws.readyState!==WebSocket.CONNECTING&&e.ws.readyState!==WebSocket.OPEN){e.notifyStatus("connecting");try{e.ws=o().connectSocket({url:e.url,protocols:["echo-protocol"]}),e.ws.onOpen(function(){console.log("WebSocket connected"),e.reconnectAttempts=0,e.reconnectTimer&&(clearTimeout(e.reconnectTimer),e.reconnectTimer=null),e.notifyStatus("connected"),t()}),e.ws.onMessage(function(t){console.log("WebSocket message received:",t.data);try{var n=JSON.parse(t.data);e.notifyMessage(n)}catch(n){console.error("Failed to parse WebSocket message:",n),e.notifyMessage({raw:t.data})}}),e.ws.onError(function(t){console.error("WebSocket error:",t),e.notifyStatus("error"),n(t)}),e.ws.onClose(function(){console.log("WebSocket closed"),e.notifyStatus("disconnected"),e.ws=null,e.reconnectAttempts<e.maxReconnectAttempts&&(e.reconnectAttempts++,console.log("Attempting to reconnect (".concat(e.reconnectAttempts,"/").concat(e.maxReconnectAttempts,")...")),e.reconnectTimer=setTimeout(function(){e.connect().catch(console.error)},e.reconnectDelay))})}catch(s){console.error("Failed to create WebSocket:",s),e.notifyStatus("error"),n(s)}}else t()})}},{key:"send",value:function(e){var t=this;return new Promise(function(n,s){if(t.ws&&t.ws.readyState===WebSocket.OPEN)try{var i="string"===typeof e?e:JSON.stringify(e);t.ws.send({data:i,success:function(){console.log("Message sent:",i),n()},fail:function(e){console.error("Failed to send message:",e),s(e)}})}catch(e){console.error("Error sending message:",e),s(e)}else s(new Error("WebSocket is not connected"))})}},{key:"disconnect",value:function(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.reconnectAttempts=0,this.notifyStatus("disconnected")}},{key:"getStatus",value:function(){if(!this.ws)return"disconnected";switch(this.ws.readyState){case WebSocket.CONNECTING:return"connecting";case WebSocket.OPEN:return"connected";case WebSocket.CLOSING:case WebSocket.CLOSED:return"disconnected";default:return"disconnected"}}},{key:"isConnected",value:function(){return null!==this.ws&&this.ws.readyState===WebSocket.OPEN}}])}(),F=null;function R(e){return F?e&&F.setUrl(e):F=new D(e||""),F}var _,j,B,q,J,L="openclaw_messages",G=100,K=(v=function(){function e(){(0,a.A)(this,e),b(this,"wsUrl",y,this),b(this,"messages",S,this),b(this,"connecting",k,this),b(this,"wsStatus",A,this),b(this,"sessionId",I,this),(0,w.A)(this,"wsService",R()),b(this,"loadMessages",z,this),b(this,"saveMessages",M,this),b(this,"loadSettings",W,this),b(this,"saveSettings",x,this),b(this,"setWsUrl",P,this),b(this,"setSessionId",U,this),b(this,"connect",O,this),b(this,"disconnect",C,this),b(this,"sendMessage",E,this),b(this,"addMessage",T,this),b(this,"updateMessageStatus",N,this),b(this,"clearMessages",X,this),this.loadMessages(),this.loadSettings(),this.setupWebSocketHandlers()}return(0,c.A)(e,[{key:"connected",get:function(){return"connected"===this.wsStatus}},{key:"setupWebSocketHandlers",value:function(){var e=this;this.wsService.onStatusChange(function(t){e.wsStatus=t}),this.wsService.onMessage(function(t){if(console.log("Received message:",t),"progress"===t.type||"complete"===t.type){var n={id:"resp_".concat(Date.now()),content:t.content,role:"assistant",timestamp:Date.now(),status:"sent"};e.addMessage(n),t.session&&!e.sessionId&&e.setSessionId(t.session)}else if("error"===t.type){var s={id:"error_".concat(Date.now()),content:"Error: ".concat(t.error||"Unknown error"),role:"assistant",timestamp:Date.now(),status:"sent"};e.addMessage(s)}})}}])}(),y=m(v.prototype,"wsUrl",[H.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),S=m(v.prototype,"messages",[H.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),k=m(v.prototype,"connecting",[H.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),A=m(v.prototype,"wsStatus",[H.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"disconnected"}}),I=m(v.prototype,"sessionId",[H.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),m(v.prototype,"connected",[H.EW],Object.getOwnPropertyDescriptor(v.prototype,"connected"),v.prototype),z=m(v.prototype,"loadMessages",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){try{var t=o().getStorageSync(L);t&&Array.isArray(t)&&(e.messages=t)}catch(e){console.error("Failed to load messages:",e)}}}}),M=m(v.prototype,"saveMessages",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){try{var t=e.messages.slice(-G);o().setStorageSync(L,t)}catch(e){console.error("Failed to save messages:",e)}}}}),W=m(v.prototype,"loadSettings",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){try{var t=o().getStorageSync("openclaw_settings");t&&(e.wsUrl=t.wsUrl||"",e.sessionId=t.sessionId||"",e.wsUrl&&e.wsService.setUrl(e.wsUrl))}catch(e){console.error("Failed to load settings:",e)}}}}),x=m(v.prototype,"saveSettings",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){try{o().setStorageSync("openclaw_settings",{wsUrl:e.wsUrl,sessionId:e.sessionId})}catch(e){console.error("Failed to save settings:",e)}}}}),P=m(v.prototype,"setWsUrl",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(t){e.wsUrl=t,e.wsService.setUrl(t),e.saveSettings()}}}),U=m(v.prototype,"setSessionId",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(t){e.sessionId=t,e.saveSettings()}}}),O=m(v.prototype,"connect",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return(0,p.A)((0,h.A)().m(function t(){var n;return(0,h.A)().w(function(t){while(1)switch(t.p=t.n){case 0:if(e.wsUrl){t.n=1;break}throw new Error("WebSocket URL is not configured");case 1:return e.connecting=!0,t.p=2,t.n=3,e.wsService.connect();case 3:t.n=5;break;case 4:throw t.p=4,n=t.v,console.error("Connection failed:",n),n;case 5:return t.p=5,e.connecting=!1,t.f(5);case 6:return t.a(2)}},t,null,[[2,4,5,6]])}))}}),C=m(v.prototype,"disconnect",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){e.wsService.disconnect()}}}),E=m(v.prototype,"sendMessage",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){var t=(0,p.A)((0,h.A)().m(function t(n){var s,i;return(0,h.A)().w(function(t){while(1)switch(t.p=t.n){case 0:if(e.connected){t.n=1;break}throw new Error("Not connected to server");case 1:return s={id:Date.now().toString(),content:n,role:"user",timestamp:Date.now(),status:"sending"},e.addMessage(s),t.p=2,t.n=3,e.wsService.send({id:s.id,content:n,session:e.sessionId||void 0});case 3:e.updateMessageStatus(s.id,"sent"),t.n=5;break;case 4:throw t.p=4,i=t.v,console.error("Failed to send message:",i),e.updateMessageStatus(s.id,"error"),i;case 5:return t.a(2)}},t,null,[[2,4]])}));return function(e){return t.apply(this,arguments)}}()}}),T=m(v.prototype,"addMessage",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(t){e.messages.push(t),e.messages.length>G&&e.messages.shift(),e.saveMessages()}}}),N=m(v.prototype,"updateMessageStatus",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(t,n){var s=e.messages.find(function(e){return e.id===t});s&&(s.status=n,e.saveMessages())}}}),X=m(v.prototype,"clearMessages",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){e.messages=[];try{o().removeStorageSync(L)}catch(e){console.error("Failed to clear messages:",e)}}}}),v),Q=new K,V=(_=(0,c.A)(function e(){(0,a.A)(this,e),b(this,"count",j,this),b(this,"increment",B,this),b(this,"decrement",q,this),b(this,"reset",J,this)}),j=m(_.prototype,"count",[H.sH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B=m(_.prototype,"increment",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){e.count+=1}}}),q=m(_.prototype,"decrement",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){e.count-=1}}}),J=m(_.prototype,"reset",[H.XI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){var e=this;return function(){e.count=0}}}),_),Y=new V,Z=n(6070),$=function(e){function t(){return(0,a.A)(this,t),(0,u.A)(this,t,arguments)}return(0,l.A)(t,e),(0,c.A)(t,[{key:"render",value:function(){return(0,Z.jsx)(d.Kq,{chatStore:Q,counterStore:Y,children:this.props.children})}}])}(f.Component),ee=$,te=n(5390),ne={pages:["pages/welcome/index","pages/chat/index","pages/settings/index","pages/index/index"],window:{backgroundTextStyle:"light",navigationBarBackgroundColor:"#fff",navigationBarTitleText:"OpenClaw",navigationBarTextStyle:"black"},tabBar:{color:"#999",selectedColor:"#1890ff",backgroundColor:"#fff",borderStyle:"black",list:[{pagePath:"pages/welcome/index",text:"Welcome",iconPath:"assets/icons/welcome.png",selectedIconPath:"assets/icons/welcome-active.png"},{pagePath:"pages/chat/index",text:"Chat",iconPath:"assets/icons/chat.png",selectedIconPath:"assets/icons/chat-active.png"},{pagePath:"pages/settings/index",text:"Settings",iconPath:"assets/icons/settings.png",selectedIconPath:"assets/icons/settings-active.png"}]}};s.mw.__taroAppConfig=ne;App((0,i.ND)(ee,g,te.Ay,ne));(0,r.initPxTransform)({designWidth:750,deviceRatio:{640:1.17,750:1,828:.905},baseFontSize:20,unitPrecision:void 0,targetUnit:void 0})}},function(e){var t=function(t){return e(e.s=t)};e.O(0,[907,96],function(){return t(980)});e.O()}]);